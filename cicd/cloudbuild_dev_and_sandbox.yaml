steps:
  - name: gcr.io/$PROJECT_ID/testrunner
    args:
      - '-c'
      - |
        set -e
        gcloud --version
        make --version
        pip --version
        python --version
        pytest --version
        poetry --version

        export BACKEND_API_URL=$_BACKEND_API_URL
        export BACKEND_API_VERSION=v1
        export SA_EMAIL=$_BACKEND_SA_EMAIL
        export VERIFY_API_URL=$_VERIFY_API_URL

        poetry install

        make load-design-system-templates

        export UI_SA_ID_TOKEN=$(gcloud auth print-identity-token --impersonate-service-account=$_UI_SA_EMAIL)
        poetry run pytest --cov=utils --cov=survey_assist_ui --cov-report=term-missing --cov-fail-under=75 | tee coverage-report.txt
        if grep -q "FAIL Required test coverage" coverage-report.txt; then
          echo "ERROR: Target coverage was not reached, stopping pipeline."
          exit 1
        fi

        poetry version -s > /workspace/version.txt

        docker build --build-arg GIT_SHA=$SHORT_SHA --build-arg VERSION="$(cat /workspace/version.txt)" --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") -t $_GAR_IMAGE:$(cat /workspace/version.txt) -t $_GAR_IMAGE:$SHORT_SHA -t $_GAR_IMAGE:latest .

        docker push $_GAR_IMAGE:$(cat /workspace/version.txt)
        docker push $_GAR_IMAGE:latest
        docker push $_GAR_IMAGE:$SHORT_SHA'

        gcloud run deploy survey-assist-ui --image=$_GAR_IMAGE:$SHORT_SHA --region $LOCATION --project $_TARGET_PROJECT_ID
    id: Unit Test, Build, Tag and Deploy UI
    entrypoint: bash
timeout: 600s
options:
  logging: CLOUD_LOGGING_ONLY
